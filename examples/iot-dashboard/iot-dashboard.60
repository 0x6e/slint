/* LICENSE BEGIN
    This file is part of the SixtyFPS Project -- https://sixtyfps.io
    Copyright (c) 2020 Olivier Goffart <olivier.goffart@sixtyfps.io>
    Copyright (c) 2020 Simon Hausmann <simon.hausmann@sixtyfps.io>

    SPDX-License-Identifier: GPL-3.0-only
    This file is also available under commercial licensing terms.
    Please contact info@sixtyfps.io for more information.
LICENSE END */

/*
 The design from this file is inspired from the design in
 https://github.com/peter-ha/qskinny/tree/iot-dashboard/examples/iot-dashboard
 Original license:
/****************************************************************************
**
** Copyright 2021 Edelhirsch Software GmbH. All rights reserved.
**
** Redistribution and use in source and binary forms, with or without
** modification, are permitted provided that the following conditions are
** met:
**
**   * Redistributions of source code must retain the above copyright
**     notice, this list of conditions and the following disclaimer.
**   * Redistributions in binary form must reproduce the above copyright
**     notice, this list of conditions and the following disclaimer in
**     the documentation and/or other materials provided with the
**     distribution.
**   * Neither the name of the copyright holder nor the names of its
**     contributors may be used to endorse or promote products derived
**     from this software without specific prior written permission.
**
** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
** "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
** A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
** OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
** SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
** LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
**
****************************************************************************/
*/

struct Palette := {
    menuBar : brush,
    mainContent : brush,
    box : brush,
    lightDisplay : brush,
    pieChart : brush,
    roundButton : brush,
    weekdayBox : brush,
    text : brush,
    shadow : brush,
}

global Skin := {
    property<bool> day: true;
    property<Palette> palette : day ? {
       menuBar : #6D7BFB,
       mainContent :  #fbfbfb,
       box :   #ffffff,
       lightDisplay : #ffffff,
       pieChart : #ffffff,
       roundButton : #f7f7f7,
       weekdayBox : #f4f4f4,
       text : #000,
       shadow : #0001, // ### added alpha
    } : {
       menuBar : #2937A7,
       mainContent : #040404,
       box : #000000,
       lightDisplay : #000000,
       pieChart : #000000,
       roundButton : #0a0a0a,
       weekdayBox : #0c0c0c,
       text : #fff,
       shadow : #fff1, // ### added alpha
    };

    property<float> f: 1.5; // FIXME: why do the font looks completely different with the same size on the QML demo

    // From Skin::initHints in Skin.cpp
    property <length> DefaultFont: 12pt * f;
    property <length> TinyFont: 9pt * f;
    property <length> SmallFont: 10pt * f;
    property <length> MediumFont: 13pt * f;
    property <length> LargeFont: 20pt * f;
    property <length> HugeFont: 27pt * f; // (also, bold)
    property <length> TitleFont: 10pt * f; // (also, bold)
}

export Clock :=  VerticalLayout {
    property <string> time <=> time_label.text;
    Text {
        text: "Current time";
        font_size: Skin.TitleFont;
        font_weight: 700;
    }
    time_label := Text {
        // FIXME: actual time
        text: "10:02:45";
        font_size: Skin.HugeFont;
        font_weight: 700;
        color: #6776FF;
    }
}

PieChartBackground := Path {
    property <float> thickness;
    property <float> inner_radius;

    fill: #aaaaaa40;

    viewbox-width: 100;
    viewbox-height: 100;

    MoveTo {
        x: 50;
        y: 0;
    }
    ArcTo {
        radius-x: 50;
        radius-y: 50;
        x: 50;
        y: 100;
        sweep: true;
    }
    ArcTo {
        radius-x: 50;
        radius-y: 50;
        x: 50;
        y: 0;
        sweep: true;
    }
    LineTo {
        x: 50;
        y: thickness;
    }
    ArcTo {
        radius-x: inner_radius;
        radius-y: inner_radius;
        x: 50;
        y: 100 - thickness;
    }
    ArcTo {
        radius-x: inner_radius;
        radius-y: inner_radius;
        x: 50;
        y: thickness;
    }
}

PieChartFill := Path {
    property <float> thickness;
    property <float> inner_radius;
    property <float> progress;

    viewbox-width: 100;
    viewbox-height: 100;

    MoveTo {
        x: 50;
        y: 0;
    }
    LineTo {
        x: 50;
        y: thickness;
    }
    ArcTo {
        radius-x: inner_radius;
        radius-y: inner_radius;
        y: 50 - inner_radius*cos(-progress * 360deg);
        x: 50 - inner_radius*sin(-progress * 360deg);
        sweep: progress > 0;
        large-arc: progress > 0.5;
    }
    LineTo {
        y: 50 - 50*cos(-progress * 360deg);
        x: 50 - 50*sin(-progress * 360deg);
    }
    ArcTo {
        radius-x: 50;
        radius-y: 50;
        x: 50;
        y: 0;
        sweep: progress < 0;
        large-arc: progress > 0.5;
    }
    LineTo {
        x: 50;
        y: 0;
    }
}

PieChartPainted := Rectangle {
    property <brush> brush <=> p.fill;
    property <float> progress;

    property <float> thickness: 15;
    property <float> inner_radius: 50 - thickness;

    back := PieChartBackground {
        width: 100%;
        height: 100%;
        thickness: root.thickness;
        inner_radius: root.inner_radius;
    }

    p := PieChartFill {
        width: 100%;
        height: 100%;
        thickness: root.thickness;
        inner_radius: root.inner_radius;
        progress: root.progress;
    }
}


// From TopBar.cpp
export TopBar := HorizontalLayout {
    padding: 5px;
    spacing: 0px;
    for item in [
        { string: "Living Room", progress: 25, value: 175, color: #ff3122, gradient: @linear-gradient(0deg, #FF5C00, #FF3122) },
        { string: "Bedroom", progress: 45, value: 205, color: #6776ff, gradient: @linear-gradient(0deg, #6776FF, #6100FF) },
        { string: "Bathroom", progress: 15, value: 115, color: #f99055, gradient: @linear-gradient(0deg, #FFCE50, #FF3122) },
        { string: "Kitchen", progress: 86, value: 289, color: #6776ff, gradient: @linear-gradient(0deg, #6776FF, #6100FF) },
    ] : VerticalLayout {
        padding: 0px;
        spacing: 0px;
        Text {
            font_size: Skin.SmallFont;
            text: item.string;
        }
        HorizontalLayout {
            PieChartPainted {
                brush: item.gradient;
                progress: item.progress / 100;
                Text {
                    width: 100%;
                    height: 100%;
                    vertical_alignment: center;
                    horizontal_alignment: center;
                    text: item.progress + "%";
                    color: item.color;
                    font_size: Skin.TinyFont;
                }
            }
            VerticalLayout {
                Text { text: item.value; }
                Text { text: "kwH"; }
            }
            Rectangle {}
        }
    }
    @children
}

// From Box.cpp
Box := Rectangle {
    property <string> title;
    background: Skin.palette.box;
    drop-shadow-offset-x: 6px;
    drop-shadow-offset-y: 6px;
    drop-shadow-blur: 6px;
    drop-shadow-color: Skin.palette.shadow;
    VerticalLayout {
        if (root.title != "") : Text {
            text <=> root.title;
            font_size: Skin.TitleFont;
        }
        spacing: 0px;
        padding: 15px;
        @children
    }
}

// From RoundedIcon.cpp
RoundedIcon := Rectangle {
    property <bool> isBright;
    property <bool> isSmall;
    property <image> iconName <=> m_graphicLabel.source;
    background: isBright ? @linear-gradient(180deg, #ff7d34, #ff3122) : @linear-gradient(180deg, #6776FF, #6100FF);
    border-radius: 6px;
    height: isSmall ? 60px : 68px;
    width: isSmall ? 60px : 68px;
    m_graphicLabel := Image {
        x: (parent.width - width) / 2;
        y: (parent.height - height) / 2;
    }
}

//from Usage.cpp
UsageSpacer := Text {
    text: "_____";
    font_size: Skin.SmallFont;
    color: #dddddd;
    horizontal_stretch: 2;
}

export Usage := Box {
    title: "Usage";
    HorizontalLayout {
        Text { text: "Usage Today"; font_size: Skin.SmallFont; }
        UsageSpacer { }
        Text { text: "0,5 kwH"; font_size: Skin.SmallFont; }
    }
    HorizontalLayout {
        Text { text: "Usage this month"; font_size: Skin.SmallFont; }
        UsageSpacer { }
        Text { text: "60 kwH"; font_size: Skin.SmallFont; }
    }
    HorizontalLayout {
        Text { text: "Total working hours"; font_size: Skin.SmallFont; }
        UsageSpacer { }
        Text { text: "125 hrs"; font_size: Skin.SmallFont; }
    }
}

// From UpAndDownButton.cpp
RoundButton := Image { //### QskPushButton
    property <bool> is_up; // ### QskAspect
    Image {
        source: is_up ? @image-url("images/up.svg") : @image-url("images/down.svg");
        x: (parent.width - width) / 2;
        y: (parent.height - height) / 2;
    }
}
UpAndDownButton := Rectangle {
    // FIXME: this is actually on the RoundButton
    border-radius: 30px;
    width: 45px;
    background: Skin.palette.roundButton;
    VerticalLayout {
        RoundButton { is_up: true; }
        RoundButton { is_up: false; }
    }
}

// From BoxWithButtons.cpp
ButtonValueLabel := Text {
    property <string> value <=> text;
    font_size: Skin.HugeFont;
    font_weight: 700;
    color: #929cb2;
}

TitleAndValueBox := VerticalLayout { horizontal-stretch: 100; }

BoxWithButtons := Box {
    property <image> iconFile <=> ri.iconName; //### in original, this is derived from title
    property <string> value <=> val.value;
    property <bool> isBright <=> ri.isBright;
    property <string> title_ <=> titleLabel.text;
    HorizontalLayout {
        padding: 8px;
        spacing: 20px;
        VerticalLayout {  // FIXME: there is no such layout in the original, we should so without it
            alignment: center;
            ri := RoundedIcon { }
        }
        TitleAndValueBox {
            titleLabel := Text {
                font_size: Skin.TitleFont;
                font_weight: 700;
            }
            val := ButtonValueLabel { }
        }
        UpAndDownButton { }
    }
}

export IndoorTemperature := BoxWithButtons {
    title_: "Indoor Temperature";
    iconFile: @image-url("images/indoor-temperature.png");
    value: "+24";
    isBright: true;
}
export Humidity := BoxWithButtons {
    property <string> humidity_percent <=> value;
    title_: "Humidity";
    iconFile: @image-url("images/humidity.png");
    value: "30%";
    isBright: false;
}

// from MyDevices.cpp
Device := VerticalLayout {
    property <string> name <=> t.text;
    property <image> iconName <=> ri.iconName; // ### based on the name in the original
    property <bool> isBright <=> ri.isBright;
    HorizontalLayout { // ### FIXME: this latour is not in the original
        alignment: center;
        ri := RoundedIcon {
            opacity: 0.15;
        }
    }
    t := Text {
        font_size: Skin.TinyFont;
        horizontal_alignment: center;
    }
}

export MyDevices := Box {
    title: "My devices";
    GridLayout {
        spacing: 15px;
        Row {
            Device{
                name: "Lamps";
                iconName: @image-url("images/lamps.png");
                isBright: true;
            }
            Device{
                name: "Music System";
                iconName: @image-url("images/music-system.png");
                isBright: false;
            }
        }
        Row {
            Device{
                name: "AC";
                iconName: @image-url("images/ac.png");
                isBright: false;
            }
            Device{
                name: "Router";
                iconName: @image-url("images/router.png");
                isBright: true;
            }
        }
    }
}

export UsageDiagram := Box {
    // WeekDayBox
    boxes := HorizontalLayout {
        padding: 0px;
        padding_bottom: 6px;
        spacing: 6px;
        for _ in 7 : Rectangle {
            background: Skin.palette.box;
            drop-shadow-offset-x: 6px;
            drop-shadow-offset-y: 6px;
            drop-shadow-blur: 6px;
            drop-shadow-color: Skin.palette.weekdayBox;
        }

    }

    Rectangle {
        // ### This is somehow a hack to have another rectangle on top of the boxes
        height: 0;
        VerticalLayout {
            y: -boxes.height;
            height: boxes.height;
            width: boxes.width;

            HorizontalLayout {
                alignment: end;
                spacing: 10px;
                // CaptionItem
                for caption in [
                    { text: "Water", color: #6776ff, },
                    { text: "Electricity", color: #ff3122, },
                    { text: "Gaz", color: #ff7d34, },
                ] : HorizontalLayout {
                    spacing: 10px;
                    padding-top: 10px;
                    padding-right: 20px;
                    VerticalLayout {
                        padding: 0px;
                        alignment: center;
                        Rectangle {
                            height: 8px;
                            width: 9px;
                            border_radius: 4px;
                            background: caption.color;
                        }
                    }
                    Text {
                        text: caption.text;
                        horizontal_alignment: center;
                    }
                }
            }

            Rectangle {
                // The datapoint is
                // FIXME: make it more curve, also fix the color
                for datapoints in [
                    {
                        values: [64.00, 64.00, 64.00, 64.00, 64.00, 64.00, 64.00, 64.00, 64.00, 64.00, 64.00, 63.99, 63.96, 63.85, 63.64, 63.30, 62.79, 62.09, 61.14, 59.93, 58.42, 56.59, 54.50, 52.23, 49.84, 47.42, 45.03, 42.76, 40.68, 38.85, 37.36, 36.27, 35.55, 35.19, 35.14, 35.39, 35.91, 36.65, 37.60, 38.73, 40.00, 41.39, 42.87, 44.41, 46.00, 47.60, 49.19, 50.76, 52.26, 53.68, 55.00, 56.19, 57.24, 58.15, 58.90, 59.51, 59.95, 60.23, 60.33, 60.26, 60.00, 59.56, 58.94, 58.17, 57.27, 56.24, 55.12, 53.92, 52.65, 51.34, 50.00, 48.65, 47.32, 46.03, 44.79, 43.65, 42.61, 41.70, 40.95, 40.37, 40.00, 39.85, 39.94, 40.26, 40.84, 41.67, 42.77, 44.15, 45.80, 47.75, 50.00, 52.54, 55.30, 58.19, 61.13, 64.04, 66.82, 69.40, 71.67, 73.57],
                        color: #ff3122
                    }, {
                        values: [36.00, 36.01, 36.11, 36.37, 36.88, 37.73, 38.98, 40.73, 43.07, 46.06, 49.80, 54.31, 59.38, 64.73, 70.09, 75.20, 79.77, 83.55, 86.24, 87.59, 87.33, 85.26, 81.61, 76.64, 70.67, 63.98, 56.86, 49.61, 42.52, 35.89, 30.00, 25.09, 21.14, 18.08, 15.83, 14.31, 13.45, 13.16, 13.37, 14.01, 15.00, 16.26, 17.73, 19.36, 21.07, 22.82, 24.55, 26.19, 27.68, 28.97, 30.00, 30.73, 31.25, 31.65, 32.04, 32.52, 33.21, 34.19, 35.58, 37.48, 40.00, 43.17, 46.80, 50.61, 54.33, 57.71, 60.47, 62.35, 63.07, 62.38, 60.00, 55.79, 50.12, 43.46, 36.31, 29.13, 22.43, 16.68, 12.37, 9.98, 10.00, 12.73, 17.76, 24.50, 32.36, 40.75, 49.09, 56.77, 63.21, 67.81, 70.00, 69.37, 66.28, 61.29, 54.96, 47.85, 40.51, 33.50, 27.37, 22.68],
                        color: #6776ff
                    } , {
                        values: [43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.50, 43.51, 43.59, 43.80, 44.20, 44.87, 45.86, 47.25, 49.10, 51.47, 54.43, 58.01, 62.05, 66.38, 70.80, 75.12, 79.16, 82.73, 85.64, 87.70, 88.73, 88.60, 87.42, 85.34, 82.55, 79.20, 75.47, 71.51, 67.51, 63.61, 60.00, 56.80, 54.04, 51.68, 49.71, 48.11, 46.86, 45.95, 45.35, 45.04, 45.00, 45.22, 45.71, 46.46, 47.50, 48.82, 50.43, 52.35, 54.58, 57.13, 60.00, 63.17, 66.45, 69.62, 72.46, 74.74, 76.24, 76.74, 76.01, 73.84, 70.00, 64.39, 57.37, 49.45, 41.12, 32.86, 25.18, 18.56, 13.49, 10.48],
                        color: #ff7d34,
                    }
                ] : Rectangle {
                    width: boxes.width;
                    height: boxes.height;
                    HorizontalLayout {
                        padding: 0; spacing: 0;
                        for dp in datapoints.values : Rectangle {
                            height: boxes.height;
                            Rectangle {
                                background: @linear-gradient(180deg, datapoints.color, transparent 100%);
                                height: parent.height * dp / 100;
                                y: parent.height - height;
                                opacity: 0.5;
                            }
                        }
                    }
                }
            }
        }
    }

    HorizontalLayout {
        padding: 0px;
        padding-top: 5px;
        // WeekDay
        for day in ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"] : Text {
            //background: blue;
            color: Skin.palette.text;
            text: day;
            font_size: Skin.TinyFont;
            horizontal_alignment: center;
        }

    }
}

// From LightIntensity.cpp
// ## FIXME

LightDimmer := Rectangle {
    property <brush> coldGradient <=> cold.fill;
    property <brush> warmGradient <=> warm.fill;

    property <float> thickness: 8;
    property <float> inner_radius: 50 - thickness;


    back := PieChartBackground {
        width: 100%;
        height: 100%;
        thickness: root.thickness;
        inner_radius: root.inner_radius;
    }

    warm := PieChartFill {
        width: 100%;
        height: 100%;
        thickness: root.thickness;
        inner_radius: root.inner_radius;
        progress: 0.25;

    }

    cold := PieChartFill {
        width: 100%;
        height: 100%;
        thickness: root.thickness;
        inner_radius: root.inner_radius;
        progress: -0.25;

    }

    knob := Path {
        width: 100%;
        height: 100%;

        fill: white;
        stroke-width: 1px;
        stroke: #929cb2;

        viewbox-width: 100;
        viewbox-height: 100;

        MoveTo {
            x: 50;
            y: - root.thickness / 4;
        }
        ArcTo {
            radius-x: root.thickness / 4;
            radius-y: root.thickness / 4;
            x: 50;
            y: root.thickness * 1.25;
        }
        ArcTo {
            radius-x: root.thickness / 4;
            radius-y: root.thickness / 4;
            x: 50;
            y: - root.thickness / 4;
        }
    }
}

export LightIntensity := Box {
    title: "Light intensity";

    property <float> thickness: 8;
    property <float> inner_radius: 50 - thickness;

    Rectangle {
        vertical_stretch: 1;
        HorizontalLayout {
            leftLabel := Text {
                text: "  0";
                font_size: Skin.SmallFont;
                vertical-alignment: center;
            }

            dimmer := LightDimmer {
                warmGradient: @linear-gradient(0deg, #ff3122, #feeeb7);
                coldGradient: @linear-gradient(0deg, #a7b0ff, #6776ff);
            }

            rightLabel := Text {
                text: "100";
                font_size: Skin.SmallFont;
                vertical-alignment: center;
            }
        }

        centreLabel := Text {
            width: dimmer.width;
            height: dimmer.height;
            x: dimmer.x;
            y: dimmer.y;
            color: #929cb2;
            text: "50%";
            font_size: Skin.MediumFont;
            vertical-alignment: center;
            horizontal-alignment: center;
        }
    }
}

// From MenuBar.cpp
MenuItem := Rectangle {
    property <image> icon <=> i.source;
    property<string> name <=> t.text;
    property<bool> active;
    background: active ? rgba(100%, 100%, 100%, 14%) : ma.has_hover ? rgba(100%, 100%, 100%, 9%) : transparent;
    ma := TouchArea {}
    HorizontalLayout {
        alignment: start;
        padding: 8px;
        padding-left: 30px;
        padding-right: 30px;
        i := Image { }
        t := Text { color: white; }
    }
}

// From MenuBar.cpp
export MenuBar := Rectangle {
    background: Skin.palette.menuBar;
    property<int> active: 0;
    minimum-width: 140px;
    VerticalLayout {
        padding-left: 0px;
        padding-top: 35px;
        padding-right: 0px;
        padding-bottom: 12px;
        spacing: 8px;
        Image {
            source: @image-url("images/main-icon.png");
        }
        //###  In the original, the icon is derived from the name
        for entry[idx] in [
            { name: "Dashboard", icon: @image-url("images/dashboard.png") },
            { name: "Rooms", icon: @image-url("images/rooms.png") },
            { name: "Devices", icon: @image-url("images/devices.png") },
            { name: "Statistics", icon: @image-url("images/statistics.png") },
            { name: "Storage", icon: @image-url("images/storage.png") },
            { name: "Members", icon: @image-url("images/members.png") },
        ] : MenuItem {
            name: entry.name;
            icon: entry.icon;
            active: root.active == idx;
        }
        Rectangle {}
        MenuItem { name: "Logout"; icon: @image-url("images/logout.png"); }
    }
}